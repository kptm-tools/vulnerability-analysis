package services

import (
	"net/http"
	"net/http/httptest"
	"net/url"
	"os"
	"strings"
	"testing"

	"github.com/stretchr/testify/assert"
)

func Test_isValidCPE(t *testing.T) {
	testCases := []struct {
		name     string
		inputCPE string
		wantErr  bool
	}{
		{
			name:     "Valid CPE",
			inputCPE: "cpe:2.3:o:microsoft:windows_10:1607:*:*:*:*:*:*:*",
			wantErr:  false,
		},
		{
			name:     "Invalid CPE length",
			inputCPE: "cpe:2.3:*:microsoft:windows_10:1607:*:*:*:*:*:*:*:*:*:*:*",
			wantErr:  true,
		},
		{
			name:     "Invalid CPE part",
			inputCPE: "cpe:2.3:*:microsoft:windows_10:1607:*:*:*:*:*:*:*",
			wantErr:  true,
		},
		{
			name:     "Invalid CPE version",
			inputCPE: "cpe:2.3:o:microsoft:windows_10:*:*:*:*:*:*:*:*",
			wantErr:  true,
		},
		{
			name:     "Short CPE",
			inputCPE: "cpe:2.3:o:microsoft:windows_10:*:*:*:*",
			wantErr:  true,
		},
		{
			name:     "Wrong Prefix CPE",
			inputCPE: "cp:2.3:o:microsoft:windows_10:*:*:*:*",
			wantErr:  true,
		},
		{
			name:     "Wrong Version CPE",
			inputCPE: "cpe:2.4:o:microsoft:windows_10:*:*:*:*",
			wantErr:  true,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			err := isValidCPE(tc.inputCPE)
			if tc.wantErr {
				assert.Error(t, err)
			} else {
				assert.NoError(t, err)
			}
		})
	}
}

func Test_fetchNvdDataByCPE_SuccessWithResults(t *testing.T) {
	// 1. Mock HTTP server
	server := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		// Assert request parameters (CPE in query)
		encodedCPE := url.QueryEscape("cpe:2.3:o:microsoft:windows_10:1607:*:*:*:*:*:*:*")
		if !strings.Contains(r.URL.RawQuery, "cpeName="+encodedCPE) {
			t.Errorf("Expected CPE query parameter in request URL %s, got %v", encodedCPE, r.URL.RawQuery)
		}
		// Load successful API response from testdata file
		content, err := os.ReadFile("testdata/nvd_api_success.json")
		if err != nil {
			t.Fatalf("Failed to read test data file: %v", err)
		}
		w.WriteHeader(http.StatusOK)
		w.Header().Set("Content-Type", "application/json")
		w.Write(content)
	}))
	defer server.Close()

	// 2. Modifyt base API URL for testing
	baseNvdApiURL = server.URL // Set to mock server URL

	// 3. Call fetchNvdDataByCPE with a valid CPE
	cpe := "cpe:2.3:o:microsoft:windows_10:1607:*:*:*:*:*:*:*"
	response, err := fetchNvdDataByCPE(cpe, baseNvdApiURL)
	// 4. Assertions
	if err != nil {
		t.Errorf("Expected no error, but got: %v", err)
	}
	if response == nil {
		t.Fatalf("Expected non-nil NvdApiResponse, but got nil")
	}
	if response.TotalResults == 0 {
		t.Errorf("Expected TotalResults > 0, got 0") // Adjust assertion based on your test data
	}
}
